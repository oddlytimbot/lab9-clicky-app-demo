"use strict";

var _templateObject = _taggedTemplateLiteralLoose(["\n  padding: 0 ", ";\n  display: flex;\n  flex-direction: row;\n  width: 100%;\n  justify-content: ", ";\n\n  @media (max-width: 700px) {\n\t\tflex-direction: ", ";\n\t}\n"], ["\n  padding: 0 ", ";\n  display: flex;\n  flex-direction: row;\n  width: 100%;\n  justify-content: ", ";\n\n  @media (max-width: 700px) {\n\t\tflex-direction: ", ";\n\t}\n"]),
    _templateObject2 = _taggedTemplateLiteralLoose(["\n  padding: ", " 0;\n  display: flex;\n  flex-direction: column;\n  flex: 1;\n"], ["\n  padding: ", " 0;\n  display: flex;\n  flex-direction: column;\n  flex: 1;\n"]),
    _templateObject3 = _taggedTemplateLiteralLoose(["\n  justify-content: center;\n  width:100%;\n  align-items: center;\n"], ["\n  justify-content: center;\n  width:100%;\n  align-items: center;\n"]),
    _templateObject4 = _taggedTemplateLiteralLoose(["\n  box-shadow:  0 1px 3px 0 rgba(0,0,0,.2), 0 1px 1px 0 rgba(0,0,0,.14), 0 2px 1px -1px rgba(0,0,0,.12);\n  justify-content: center;\n  align-items: center;\n  margin: 20px;\n  padding: ", ";\n  margin-top: 50px;\n"], ["\n  box-shadow:  0 1px 3px 0 rgba(0,0,0,.2), 0 1px 1px 0 rgba(0,0,0,.14), 0 2px 1px -1px rgba(0,0,0,.12);\n  justify-content: center;\n  align-items: center;\n  margin: 20px;\n  padding: ", ";\n  margin-top: 50px;\n"]),
    _templateObject5 = _taggedTemplateLiteralLoose(["\n  background: ", ";\n  width: 100%;\n"], ["\n  background: ", ";\n  width: 100%;\n"]),
    _templateObject6 = _taggedTemplateLiteralLoose(["\n  flex:2;\n"], ["\n  flex:2;\n"]),
    _templateObject7 = _taggedTemplateLiteralLoose(["\n  padding: ", "px 0px;\n"], ["\n  padding: ", "px 0px;\n"]),
    _templateObject8 = _taggedTemplateLiteralLoose(["\n  height: 200px;\n  width: 100%;\n  background-image: url(", ");\n  background-position: center;\n  background-size: cover;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\n@media (max-width: 500px) {\n  background-image: none;\n}\n"], ["\n  height: 200px;\n  width: 100%;\n  background-image: url(", ");\n  background-position: center;\n  background-size: cover;\ndisplay: flex;\njustify-content: center;\nalign-items: center;\n@media (max-width: 500px) {\n  background-image: none;\n}\n"]),
    _templateObject9 = _taggedTemplateLiteralLoose(["\n  color: ", ";\n  text-align: center;\n  width: ", ";\n@media (max-width: 500px) {\n  color: #000;\n  width: 70%;\n}\n"], ["\n  color: ", ";\n  text-align: center;\n  width: ", ";\n@media (max-width: 500px) {\n  color: #000;\n  width: 70%;\n}\n"]),
    _templateObject10 = _taggedTemplateLiteralLoose(["\n  width: 95%;\n  max-width: 120px;\n  border: none;\n  padding: 8px;\n  border-radius: 2px; \n  background: ", ";\n  color: white;\n  text-transform: uppercase;\n  font-size: 14px;\n  outline: none;\n  cursor: pointer;\n  \n  :hover {\n    background-color: gold;\n  }\n"], ["\n  width: 95%;\n  max-width: 120px;\n  border: none;\n  padding: 8px;\n  border-radius: 2px; \n  background: ", ";\n  color: white;\n  text-transform: uppercase;\n  font-size: 14px;\n  outline: none;\n  cursor: pointer;\n  \n  :hover {\n    background-color: gold;\n  }\n"]),
    _templateObject11 = _taggedTemplateLiteralLoose(["\n  color: ", ";\n  opacity: ", ";\n  padding: ", "em;\n  cursor: pointer;\n  &:hover {\n    opacity: ", ";\n\t}\n"], ["\n  color: ", ";\n  opacity: ", ";\n  padding: ", "em;\n  cursor: pointer;\n  &:hover {\n    opacity: ", ";\n\t}\n"]),
    _templateObject12 = _taggedTemplateLiteralLoose(["\n  padding: 12px;\n  font-weight: 500;\n"], ["\n  padding: 12px;\n  font-weight: 500;\n"]),
    _templateObject13 = _taggedTemplateLiteralLoose(["\ndisplay: flex;\nflex-direction: column;\nwidth: 300px;\n"], ["\ndisplay: flex;\nflex-direction: column;\nwidth: 300px;\n"]),
    _templateObject14 = _taggedTemplateLiteralLoose(["\nwidth: 46%;\nmax-width: 100px;\nbackground: #efefef;\nborder: none;\npadding: 8px;\nborder-radius: 2px; \ncolor: ", ";\ntext-transform: uppercase;\nfont-size: 12px;\noutline: none;\ncursor: pointer;\n  \n  :hover {\n    background-color: ", ";\n    color: white;\n  }\n"], ["\nwidth: 46%;\nmax-width: 100px;\nbackground: #efefef;\nborder: none;\npadding: 8px;\nborder-radius: 2px; \ncolor: ", ";\ntext-transform: uppercase;\nfont-size: 12px;\noutline: none;\ncursor: pointer;\n  \n  :hover {\n    background-color: ", ";\n    color: white;\n  }\n"]),
    _templateObject15 = _taggedTemplateLiteralLoose(["\nwidth: 90%;\nmargin-bottom: 1em;\nborder: none;\nborder-bottom: 1px solid #d2d0d0;\n\n:focus{\n  border: none;\n  outline: none;\n  border-bottom: 2px solid ", ";\n}\n"], ["\nwidth: 90%;\nmargin-bottom: 1em;\nborder: none;\nborder-bottom: 1px solid #d2d0d0;\n\n:focus{\n  border: none;\n  outline: none;\n  border-bottom: 2px solid ", ";\n}\n"]),
    _templateObject16 = _taggedTemplateLiteralLoose(["\nwidth: 100%;\n"], ["\nwidth: 100%;\n"]),
    _templateObject17 = _taggedTemplateLiteralLoose(["\nmargin-top: 10px;\ntext-align: left;\npadding: 15px;\n"], ["\nmargin-top: 10px;\ntext-align: left;\npadding: 15px;\n"]);

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _taggedTemplateLiteralLoose(strings, raw) { strings.raw = raw; return strings; }

var styled = styled.default;

//firebase configuration
var config = {
  apiKey: "AIzaSyBS5EkB1pPo3i8c_0xN6NZW6kRHHf5ET8U",
  authDomain: "inm220test.firebaseapp.com",
  databaseURL: "https://inm220test.firebaseio.com",
  storageBucket: "inm220test.appspot.com",
  messagingSenderId: "913626275002"
};
firebase.initializeApp(config);

//enforce accessibility
var PRIMARYCOLOR = {
  COLOR: '#ffab40',
  OFFLINECOLOR: 'red',
  TEXTCOLOR: '#000000',
  TEXTALPHAMIN: '.59',
  TEXTALPHAMAX: '1'
};
var HEADING = {
  VSPACE: '10'
};
var SPACEONE = '.5';

var Row = styled.div(_templateObject, function (props) {
  return props.space ? props.space : '0';
}, function (props) {
  return props.rowJustify ? props.rowJustify : "center";
}, function (props) {
  return props.stack ? 'column' : 'row';
});

var Column = styled.div(_templateObject2, function (props) {
  return props.space ? props.space : '0';
});

var Container = Column.extend(_templateObject3);
var Paper = Column.extend(_templateObject4, function (props) {
  return props.paperPadding ? props.paperPadding : "20px";
});
var MenuBar = styled.section(_templateObject5, function (props) {
  return props.connected ? PRIMARYCOLOR.COLOR : PRIMARYCOLOR.OFFLINECOLOR;
});
var FlexSpan = styled.span(_templateObject6);
var H4 = styled.h4(_templateObject7, HEADING.VSPACE);
var H5 = styled.h5(_templateObject7, HEADING.VSPACE);

var HeroHeader = styled.div(_templateObject8, function (props) {
  return props.background ? props.background : "none";
});

var HeaderText = styled.h2(_templateObject9, function (props) {
  return props.headerTextColour ? props.headerTextColour : "white";
}, function (props) {
  return props.headerTextWidth ? props.headerTextwidth : "30%";
});

var Button = styled.button(_templateObject10, PRIMARYCOLOR.COLOR);
var MenuIcon = styled.a(_templateObject11, PRIMARYCOLOR.TEXTCOLOR, PRIMARYCOLOR.TEXTALPHAMIN, SPACEONE, PRIMARYCOLOR.TEXTALPHAMAX);

var MenuText = styled.h4(_templateObject12);

var Form = styled.form(_templateObject13);
var SubmitButton = styled.input(_templateObject14, PRIMARYCOLOR.TEXTCOLOR, PRIMARYCOLOR.COLOR);
var InputField = styled.input(_templateObject15, PRIMARYCOLOR.COLOR);
var TextAreaField = styled.textarea(_templateObject16);
var FormLabel = styled.h4(_templateObject17);
//is localstorage available in this browser?
//pass 'localStorage' to test this in current browser
var storageAvailable = function storageAvailable(type) {
  try {
    var _storage = window[type],
        x = '__storage_test__';
    //try putting an item in storage and removing it. Some older browsers
    //have a localStorage object, but the API is not implemented
    _storage.setItem(x, x);
    _storage.removeItem(x);
    return true;
  } catch (e) {
    //use instanceof to cast the error to DOMException so we can get the
    //error code (different in firefox)
    //it is possible for localStorage to become full!
    return e instanceof DOMException && (
    // everything except Firefox
    e.code === 22 ||
    // Firefox
    e.code === 1014 ||
    // test name field too, because code might not be present
    // everything except Firefox
    e.name === 'QuotaExceededError' ||
    // Firefox
    e.name === 'NS_ERROR_DOM_QUOTA_REACHED') &&
    // acknowledge QuotaExceededError only if there's somethinicicong already stored
    storage.length !== 0;
  }
};

//sync these with firebase database
//these two functions are on the global scope, probably best to move them
var coffeesFromStorage = function coffeesFromStorage() {
  if (storageAvailable('localStorage')) {
    //look in storage for coffees
    var total = window.localStorage.getItem('total');
    return total || 0;
  } else {
    //storage is not available
    return "0";
  }
};
var putCoffeeInStorage = function putCoffeeInStorage() {
  var amt = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];

  if (storageAvailable('localStorage')) {
    var total = Number(window.localStorage.getItem('total')) || 0;
    var newTotal = amt > 1 ? amt : total + amt;
    window.localStorage.setItem('total', newTotal);
  } else {
    alert("Local storage not available.");
  }
};

var ProxiedButton = function ProxiedButton(props) {
  var drink = function drink(evt) {

    props.action(); //state hoist yo!
  };
  return React.createElement(
    Button,
    { onClick: drink },
    props.label
  );
};

var AuthState = function (_React$Component) {
  _inherits(AuthState, _React$Component);

  function AuthState(props) {
    _classCallCheck(this, AuthState);

    var _this = _possibleConstructorReturn(this, _React$Component.call(this, props));

    _this.state = {
      userRegistered: false,
      userLoggedIn: false
    };
    return _this;
  }

  AuthState.prototype.componentWillMount = function componentWillMount() {
    this.initAuthentication();
  };
  //listens for changes in authentication state

  AuthState.prototype.initAuthentication = function initAuthentication() {
    var _this2 = this;

    firebase.auth().onAuthStateChanged(function (user) {
      if (user) {
        console.log("Person is authenticated");
        _this2.setState({
          userRegistered: true,
          userLoggedIn: true
        });
      } else {
        console.log("Person is NOT authenticated");
        _this2.setState({
          userRegistered: false,
          userLoggedIn: false
        });
      }
    });
  };

  AuthState.prototype.signOut = function signOut() {
    console.log("Log out from firebase");
    return firebase.auth().signOut();
  };

  AuthState.prototype.createUserWithEmailAndPassword = function createUserWithEmailAndPassword(_ref) {
    var email = _ref.email;
    var password = _ref.password;

    return firebase.auth().createUserWithEmailAndPassword(email, password);
  };

  AuthState.prototype.signInWithEmailAndPassword = function signInWithEmailAndPassword(_ref2) {
    var email = _ref2.email;
    var password = _ref2.password;

    return firebase.auth().signInWithEmailAndPassword(email, password);
  };

  AuthState.prototype.renderChildren = function renderChildren(children) {
    var _this3 = this;

    return React.Children.map(children, function (child) {
      //don't render children that require auth if user is not authenticated
      if (child.props.authenticationRequired && !_this3.state.userLoggedIn) {
        return React.createElement(
          "div",
          null,
          React.createElement(Settings, { authenticated: _this3.state.userLoggedIn, signOut: _this3.signOut.bind(_this3), logIn: _this3.signInWithEmailAndPassword.bind(_this3), register: _this3.createUserWithEmailAndPassword.bind(_this3) })
        );
      }
      //create a clone of the child
      var cloned = React.cloneElement(child, {
        authenticated: _this3.state.userLoggedIn,
        signOut: _this3.signOut.bind(_this3)
      });
      //wrapped, cloned item is returned
      return cloned;
    });
  };

  //change the render so it injects props for authentication status into all children

  AuthState.prototype.render = function render() {
    return React.createElement(
      "div",
      null,
      this.renderChildren(this.props.children)
    );
  };

  return AuthState;
}(React.Component);

var AuthenticatedProvider = function AuthenticatedProvider(props) {
  return React.createElement(
    AuthState,
    null,
    React.createElement(CoffeeState, { authenticationRequired: true })
  );
};

var Settings = function (_React$Component2) {
  _inherits(Settings, _React$Component2);

  function Settings(props) {
    _classCallCheck(this, Settings);

    var _this4 = _possibleConstructorReturn(this, _React$Component2.call(this, props));

    _this4.state = {
      email: "",
      password: ""
    };
    return _this4;
  }

  Settings.prototype.onChange = function onChange(evt) {
    var _setState;

    this.setState((_setState = {}, _setState[evt.target.name] = evt.target.value, _setState));
  };

  Settings.prototype.onSubmit = function onSubmit(evt) {
    evt.preventDefault();
    //for better validation, see advanced example
    if (this.state.email && this.state.password) {
      switch (evt.target.value) {
        case "Log In":
          this.props.logIn(this.state).then(function () {
            console.log("login success");
          }).catch(function (err) {
            alert(err.message);
          });
          break;
        case "Register":
          this.props.register(this.state).then(function () {
            console.log("register success");
          }).catch(function (err) {
            alert(err.message);
          });
          break;
      }
    }
  };

  Settings.prototype.render = function render() {
    return React.createElement(
      "div",
      null,
      this.props.authenticated ? React.createElement(LogoutForm, { action: this.props.signOut }) : React.createElement(LoginForm, { onSubmit: this.onSubmit.bind(this), onChange: this.onChange.bind(this), email: this.state.email, password: this.state.password })
    );
  };

  return Settings;
}(React.Component);

var LoginForm = function LoginForm(props) {
  return React.createElement(
    Container,
    null,
    React.createElement(
      HeroHeader,
      null,
      React.createElement(
        HeaderText,
        { headerTextColour: "black", headerTextWidth: "70%" },
        "You count on coffee. We count your coffee. "
      )
    ),
    React.createElement(
      Paper,
      { paperPadding: "0px" },
      React.createElement(
        MenuBar,
        { connected: true },
        React.createElement(
          MenuText,
          null,
          "Log in or Register"
        )
      ),
      React.createElement(
        "div",
        { className: "info" },
        React.createElement(
          Form,
          null,
          React.createElement(
            "label",
            null,
            React.createElement(
              FormLabel,
              null,
              "Email:"
            ),
            React.createElement(InputField, { onChange: props.onChange, name: "email", type: "text", value: props.email })
          ),
          React.createElement(
            "label",
            null,
            React.createElement(
              FormLabel,
              null,
              "Password:"
            ),
            React.createElement(InputField, { onChange: props.onChange, name: "password", type: "password", value: props.password })
          ),
          React.createElement(
            Row,
            { rowJustify: "space-around" },
            React.createElement(SubmitButton, { type: "submit", value: "Log In", onClick: props.onSubmit }),
            React.createElement(SubmitButton, { type: "submit", value: "Register", onClick: props.onSubmit })
          )
        )
      )
    )
  );
};
var LogoutForm = function LogoutForm(props) {
  return React.createElement(
    "button",
    { onClick: props.action },
    "Log Out"
  );
};

var CoffeeState = function (_React$Component3) {
  _inherits(CoffeeState, _React$Component3);

  function CoffeeState(props) {
    _classCallCheck(this, CoffeeState);

    var _this5 = _possibleConstructorReturn(this, _React$Component3.call(this, props));

    _this5.state = {
      total: coffeesFromStorage()
    };

    _this5.moreCoffee = _this5.moreCoffee.bind(_this5);

    return _this5;
  }

  CoffeeState.prototype.componentDidMount = function componentDidMount() {
    this.loadData();
  };

  CoffeeState.prototype.loadData = function loadData() {
    var _this6 = this;

    var connectedRef = firebase.database().ref('.info/connected');
    connectedRef.on("value", function (snap) {
      if (snap.val() === true) {
        console.log("connected");
        _this6.setState({ connected: true });
      } else {
        _this6.setState({ connected: false });
      }
    });
    //'value' events will only fire if the person is online and can connect to database
    //when such an event happens, this function syncs the localstore to database
    firebase.database().ref('coffees').on('value', function (snapshot) {
      var dbTotal = snapshot.val() ? snapshot.val().total : 0; //could be null if no coffees tracked
      var localTotal = coffeesFromStorage();

      if (dbTotal > localTotal) {
        console.log("Update local store");
        putCoffeeInStorage(dbTotal);
        _this6.setState({ total: dbTotal });
      } else if (localTotal > dbTotal) {
        firebase.database().ref('coffees').set({ total: localTotal });
      } else if (localTotal == dbTotal) {
        console.log("Synced to database! " + localTotal);
      }
      //set state?
    });
  };
  //default params yo!

  CoffeeState.prototype.moreCoffee = function moreCoffee() {
    var amt = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];

    putCoffeeInStorage(); //there aren't really events for localStorage success/fail
    //immutable state yo!
    var tempState = Object.assign({}, this.state);
    //switch to update database?
    tempState.total = Number(tempState.total) + amt;
    this.setState(tempState);
  };

  CoffeeState.prototype.render = function render() {
    return React.createElement(UI, { total: this.state.total, action: this.moreCoffee, connected: this.state.connected, signOut: this.props.signOut });
  };

  return CoffeeState;
}(React.Component);

var UI = function UI(props) {
  return React.createElement(
    Container,
    null,
    React.createElement(
      MenuBar,
      { connected: props.connected },
      React.createElement(
        Row,
        null,
        React.createElement(
          MenuIcon,
          null,
          React.createElement(
            "i",
            { className: "material-icons" },
            "menu"
          )
        ),
        React.createElement(FlexSpan, null),
        React.createElement(
          MenuIcon,
          null,
          React.createElement(
            "i",
            { className: "material-icons" },
            "alarm"
          )
        ),
        React.createElement(ProxiedButton, { action: props.signOut, label: "Logout" })
      )
    ),
    React.createElement(
      HeroHeader,
      { background: "https://www.healthline.com/hlcmsresource/images/News/091316_coffeems_BODY.jpg" },
      React.createElement(
        HeaderText,
        null,
        "So you think you might have a coffee craving?"
      )
    ),
    React.createElement(
      Paper,
      null,
      React.createElement(
        "div",
        null,
        React.createElement(
          Row,
          null,
          React.createElement("span", { className: "icon-coffee" })
        ),
        React.createElement(
          Column,
          null,
          React.createElement(
            Row,
            null,
            React.createElement(
              Column,
              null,
              React.createElement(
                "p",
                null,
                "Let's track some numbers and find out"
              )
            )
          ),
          React.createElement(
            Row,
            null,
            React.createElement(
              H5,
              null,
              "Total Coffees:",
              props.total
            )
          ),
          React.createElement(
            Row,
            null,
            React.createElement(ProxiedButton, { action: props.action, label: "Drink" })
          ),
          React.createElement(Row, null)
        )
      )
    )
  );
};

ReactDOM.render(React.createElement(AuthenticatedProvider, null), document.querySelector('#exampleOne'));